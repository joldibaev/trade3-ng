<!-- Header -->
<div class="flex flex-col justify-between gap-4 sm:flex-row sm:items-center">
  <div>
    <h1 class="text-2xl font-bold tracking-tight text-slate-900">Номенклатура</h1>
    <p class="text-sm text-slate-500">Управление каталогом товаров и запасами</p>
  </div>
  <button
    uiButton
    variant="primary"
    icon="outline-plus"
    class="bg-emerald-600 text-white hover:bg-emerald-700"
    (click)="createProduct()"
  >
    Добавить товар
  </button>
</div>

@if (products.isLoading() && !products.value()) {
  <div class="flex h-64 items-center justify-center">
    <ui-loading [width]="40" [height]="40" />
  </div>
} @else {
  <!-- Stats Cards -->
  <div class="grid grid-cols-1 gap-6 md:grid-cols-4">
    @for (stat of stats(); track stat.label) {
      <ui-card class="flex items-center gap-4 p-6">
        <div
          class="flex h-12 w-12 shrink-0 items-center justify-center rounded-xl bg-emerald-50 text-emerald-600"
        >
          <ui-icon width="24" height="24" [name]="stat.icon || 'outline-box'" />
        </div>

        <div>
          <p class="text-sm font-medium text-slate-500">{{ stat.label }}</p>
          <p class="text-2xl font-bold text-slate-900">{{ stat.value | number }}</p>
        </div>
      </ui-card>
    }
  </div>

  <!-- Main Content: Split View -->
  <div class="grid flex-1 grid-cols-12 gap-6 pb-6">
    <!-- Left Panel: Categories -->
    <div class="hidden lg:col-span-3 lg:block">
      <div class="flex flex-col rounded-lg border border-slate-200 bg-white p-4">
        <div class="mb-4">
          <h2>Категории</h2>
          <p class="text-xs text-slate-500">
            Выбрано:
            {{ selectedCategoryId() ? getCategoryName(selectedCategoryId()) : 'Все товары' }}
          </p>
        </div>

        <div class="mb-2 flex items-center gap-1">
          <button
            uiButton
            variant="secondary"
            size="sm"
            icon="outline-plus"
            (click)="openCategoryDialog()"
          >
            Категория
          </button>
          @if (selectedCategoryId()) {
            <button
              uiButton
              variant="ghost"
              size="sm"
              iconOnly
              icon="outline-edit"
              (click)="editCurrentCategory()"
            ></button>
            <button
              uiButton
              variant="danger"
              size="sm"
              iconOnly
              icon="outline-trash"
              (click)="deleteCurrentCategory()"
            ></button>
          }
        </div>

        <ui-card class="flex-1 p-2">
          @if (categories.hasValue()) {
            <ui-tree [items]="rootCategories()" [(selected)]="selectedTree" />
          }
        </ui-card>
      </div>
    </div>

    <!-- Right Panel: Products Table -->
    <div class="col-span-12 flex flex-col gap-4 lg:col-span-9">
      <!-- Search Toolbar -->
      <div>
        <ui-input
          placeholder="Поиск по названию, коду или категории..."
          icon="outline-search"
          class="w-full md:w-80"
          [formField]="formData.query"
        ></ui-input>
      </div>

      <ui-card class="flex flex-col">
        <!-- Table -->
        <ui-table
          [columns]="columns()"
          [trackField]="'id'"
          [data]="filteredProducts()"
          [loading]="products.isLoading()"
          [templates]="{
            name: nameTpl,
            actions: actionsTpl,
          }"
          (selectedChanged)="selectedProduct.set($event)"
        />
      </ui-card>
    </div>
  </div>
}

<!-- Templates -->
<ng-template #nameTpl let-row>
  <div class="flex items-center gap-3 py-1">
    <div
      class="flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-slate-100/80 p-2 text-slate-500"
    >
      <ui-icon name="outline-box" width="20" height="20" />
    </div>
    <div class="flex flex-col overflow-hidden">
      <span class="truncate font-semibold text-slate-900">{{ row.name }}</span>
      <span class="truncate text-xs text-slate-500">{{ getCategoryName(row.categoryId) }}</span>
    </div>
  </div>
</ng-template>

<ng-template #actionsTpl let-row>
  <div class="flex items-center justify-end gap-1">
    <button
      uiButton
      variant="ghost"
      size="sm"
      iconOnly
      icon="outline-eye"
      class="text-slate-400 hover:text-slate-600"
      (click)="selectedProduct.set(row); openProductPage()"
    ></button>
    <button
      uiButton
      variant="ghost"
      size="sm"
      iconOnly
      icon="outline-edit"
      class="text-slate-400 hover:text-slate-600"
      (click)="editProduct(row)"
    ></button>
    <button
      uiButton
      variant="ghost"
      size="sm"
      iconOnly
      icon="outline-trash"
      class="text-slate-400 hover:text-red-600"
      (click)="deleteProduct(row)"
    ></button>
  </div>
</ng-template>
