<!-- Header -->
<div class="flex flex-col justify-between gap-4 sm:flex-row sm:items-center">
  <div>
    <h1 class="text-2xl font-bold tracking-tight text-slate-900">Номенклатура</h1>
    <p class="text-sm text-slate-500">Управление каталогом товаров и запасами</p>
  </div>
  <button
    uiButton
    variant="primary"
    icon="outline-plus"
    class="bg-emerald-600 text-white hover:bg-emerald-700"
    (click)="createProduct()"
  >
    Добавить товар
  </button>
</div>

@if (products.isLoading() && !products.value()) {
  <div class="flex h-64 items-center justify-center">
    <ui-loading [width]="40" [height]="40" />
  </div>
} @else {
  <!-- Stats Cards -->
  <div class="grid grid-cols-1 gap-6 md:grid-cols-4">
    @for (stat of stats(); track stat.label) {
      <ui-card class="flex items-center gap-4 p-6">
        <div
          class="flex h-12 w-12 shrink-0 items-center justify-center rounded-xl bg-emerald-50 text-emerald-600"
        >
          <ui-icon width="24" height="24" [name]="stat.icon || 'outline-box'" />
        </div>

        <div>
          <p class="text-sm font-medium text-slate-500">{{ stat.label }}</p>
          <p class="text-2xl font-bold text-slate-900">{{ stat.value | number }}</p>
        </div>
      </ui-card>
    }
  </div>

  <!-- Main Content: Split View -->
  <div class="grid flex-1 grid-cols-12 gap-6 pb-6">
    <!-- Left Panel: Categories -->
    <div class="hidden lg:col-span-3 lg:block">
      <div class="flex flex-col rounded-lg border border-slate-200 bg-white p-4">
        <div class="mb-4">
          <h2>Категории</h2>
          <p class="text-xs text-slate-500">
            Выбрано:
            {{
              selectedCategoryId() ? categoryMap().get(selectedCategoryId() || '') : 'Все товары'
            }}
          </p>
        </div>

        <div class="mb-2 flex items-center gap-1">
          <button
            uiButton
            variant="secondary"
            size="sm"
            icon="outline-plus"
            (click)="openCategoryDialog()"
          >
            Категория
          </button>
          @if (selectedCategoryId()) {
            <button
              uiButton
              variant="ghost"
              size="sm"
              iconOnly
              icon="outline-edit"
              (click)="editCurrentCategory()"
            ></button>
            <button
              uiButton
              variant="danger"
              size="sm"
              iconOnly
              icon="outline-trash"
              (click)="deleteCurrentCategory()"
            ></button>
          }
        </div>

        <ui-card class="flex-1 p-2">
          @if (categories.hasValue()) {
            <ui-tree [items]="rootCategories()" [(selected)]="selectedTree" />
          }
        </ui-card>
      </div>
    </div>

    <!-- Right Panel: Products Table -->
    <div class="col-span-12 flex flex-col gap-4 lg:col-span-9">
      <!-- Search Toolbar -->
      <div>
        <ui-input
          placeholder="Поиск по названию, коду или категории..."
          icon="outline-search"
          class="w-full md:w-80"
          [formField]="formData.query"
        ></ui-input>
      </div>

      <ui-card>
        <ui-table [loading]="products.isLoading()" [isEmpty]="!filteredProducts().length">
          <tr header>
            <th style="width: 100px">Код</th>
            <th style="width: 300px">Название товара</th>
            <th style="width: 120px">Цена</th>
            <th style="width: 100px">Остаток</th>
            <th style="width: 120px">Статус</th>
            <th style="width: 100px" class="text-right">Actions</th>
          </tr>

          @for (row of filteredProducts(); track row.id) {
            <tr class="hover:bg-slate-50/50">
              <!-- Code -->
              <td>
                <div class="group flex items-center gap-2">
                  <span class="font-mono text-xs font-semibold text-slate-500" [title]="row.id">
                    ...{{ row.id | slice: -10 }}
                  </span>
                  <!-- Copy button could be added here if needed, keeping it simple for now -->
                </div>
              </td>

              <!-- Name -->
              <td>
                <div class="flex items-center gap-3 py-1">
                  <div
                    class="flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-slate-100/80 p-2 text-slate-500"
                  >
                    <ui-icon name="outline-box" width="20" height="20" />
                  </div>
                  <div class="flex flex-col overflow-hidden">
                    <span class="truncate font-semibold text-slate-900">{{ row.name }}</span>
                    <span class="truncate text-xs text-slate-500">
                      {{ row.categoryName }}
                    </span>
                  </div>
                </div>
              </td>

              <!-- Price -->
              <td class="font-bold">
                {{ row.displayPrice }}
              </td>

              <!-- Stock -->
              <td class="font-medium text-emerald-600">
                {{ row.displayStock }}
              </td>

              <!-- Status -->
              <td>
                <span
                  class="inline-flex items-center rounded-full bg-emerald-50 px-2 py-1 text-xs font-medium text-emerald-700 ring-1 ring-emerald-600/20 ring-inset"
                >
                  Активен
                </span>
              </td>

              <!-- Actions -->
              <td class="text-right">
                <div class="flex items-center justify-end gap-1">
                  <button
                    uiButton
                    variant="ghost"
                    size="sm"
                    iconOnly
                    icon="outline-eye"
                    (click)="selectedProduct.set(row); openProductPage()"
                  ></button>
                  <button
                    uiButton
                    variant="ghost"
                    size="sm"
                    iconOnly
                    icon="outline-edit"
                    (click)="editProduct(row)"
                  ></button>
                  <button
                    uiButton
                    variant="danger"
                    size="sm"
                    iconOnly
                    icon="outline-trash"
                    (click)="deleteProduct(row)"
                  ></button>
                </div>
              </td>
            </tr>
          }
        </ui-table>
      </ui-card>
    </div>
  </div>
}
