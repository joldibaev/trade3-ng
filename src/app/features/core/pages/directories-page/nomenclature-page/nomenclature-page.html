<!-- Header -->
<div class="flex flex-col justify-between gap-4 sm:flex-row sm:items-center">
  <ui-title title="Номенклатура" caption="Управление каталогом товаров и запасами" />

  <button
    uiButton
    variant="primary"
    icon="outline-plus"
    class="bg-primary-600 hover:bg-primary-700 text-white"
    (click)="createProduct()"
  >
    Добавить товар
  </button>
</div>

@if (products.isLoading()) {
  <div class="flex h-64 items-center justify-center">
    <ui-loading [width]="40" [height]="40" />
  </div>
} @else {
  <!-- Stats Cards -->
  <div class="grid grid-cols-1 gap-6 md:grid-cols-4">
    @for (stat of stats(); track stat) {
      <ui-stat-card
        [label]="stat.label"
        [value]="stat.value"
        [icon]="stat.icon"
        [color]="stat.color"
      />
    }
  </div>

  <!-- Main Content: Split View -->
  <div class="grid flex-1 grid-cols-12 gap-6 pb-6">
    <!-- Left Panel: Categories -->
    <div class="hidden lg:col-span-3 lg:block">
      <div class="flex flex-col rounded-lg border border-slate-200 bg-white p-4">
        <div class="mb-4">
          <h2>Категории</h2>
          <p class="text-xs text-slate-500">
            Выбрано:
            {{
              selectedCategoryId() ? categoryMap().get(selectedCategoryId() || '') : 'Все товары'
            }}
          </p>
        </div>

        <div class="mb-2 flex items-center gap-1">
          <button
            uiButton
            variant="secondary"
            size="sm"
            icon="outline-plus"
            (click)="openCategoryDialog()"
          >
            Категория
          </button>
          @if (selectedCategoryId()) {
            <button
              uiButton
              variant="ghost"
              size="sm"
              iconOnly
              icon="outline-edit"
              (click)="editCurrentCategory()"
            ></button>
            <button
              uiButton
              variant="danger"
              size="sm"
              iconOnly
              icon="outline-trash"
              (click)="deleteCurrentCategory()"
            ></button>
          }
        </div>

        <ui-card class="flex-1 p-2">
          @if (categories.hasValue()) {
            <ui-tree [items]="rootCategories()" [(selected)]="selectedTree" />
          }
        </ui-card>
      </div>
    </div>

    <!-- Right Panel: Products Table -->
    <div class="col-span-12 space-y-4 lg:col-span-9">
      <!-- Search Toolbar -->
      <div>
        <ui-input
          placeholder="Поиск по названию, коду или категории..."
          icon="outline-search"
          class="w-full md:w-80"
          [formField]="formData.query"
        ></ui-input>
      </div>

      @if (products.hasValue()) {
        <ui-card>
          <ui-table [dataSource]="filteredProducts()">
            <ng-container cdkColumnDef="name">
              <th *cdkHeaderCellDef cdk-header-cell>Name</th>
              <td *cdkCellDef="let element" cdk-cell>
                <div class="flex items-center gap-2">
                  <!-- icon -->
                  <div
                    class="rounded-squircle flex h-10 w-10 shrink-0 items-center justify-center bg-linear-to-br from-purple-500 to-purple-600 text-white shadow-sm"
                  >
                    <ui-icon name="outline-box" width="20" height="20" />
                  </div>

                  <div class="flex flex-col">
                    <span class="font-semibold">{{ element.name }}</span>
                    <span class="text-xs text-slate-500">{{ element.id }}</span>
                  </div>
                </div>
              </td>
            </ng-container>

            <ng-container cdkColumnDef="article">
              <th *cdkHeaderCellDef cdk-header-cell>Артикул</th>
              <td *cdkCellDef="let element" cdk-cell>{{ element.article ?? '-' }}</td>
            </ng-container>

            <ng-container cdkColumnDef="category">
              <th *cdkHeaderCellDef cdk-header-cell>Категория</th>
              <td *cdkCellDef="let element" cdk-cell>{{ element.category.name }}</td>
            </ng-container>

            <ng-container cdkColumnDef="stocks">
              <th *cdkHeaderCellDef cdk-header-cell>Остатки</th>
              <td *cdkCellDef="let element" cdk-cell>
                <ul>
                  @if (element.stocks.length) {
                    @for (store of stores.value(); track store.id) {
                      <li class="flex justify-between text-xs">
                        <span>{{ store.name }}:</span>
                        <span>0</span>
                      </li>
                    }
                  } @else {
                    -
                  }
                </ul>
              </td>
            </ng-container>

            <ng-container cdkColumnDef="isActive">
              <th *cdkHeaderCellDef cdk-header-cell>Остатки</th>
              <td *cdkCellDef="let element" cdk-cell>
                <ui-badge [variant]="element.isActive ? 'success' : 'neutral'">
                  {{ element.isActive ? 'Активен' : 'Неактивен' }}
                </ui-badge>
              </td>
            </ng-container>

            <ng-container cdkColumnDef="action">
              <th *cdkHeaderCellDef cdk-header-cell></th>
              <td *cdkCellDef="let element" cdk-cell>
                <div class="flex items-center justify-end gap-1">
                  <button
                    uiButton
                    variant="ghost"
                    size="sm"
                    iconOnly
                    icon="outline-eye"
                    (click)="openProductPage(element)"
                  ></button>
                  <button
                    uiButton
                    variant="ghost"
                    size="sm"
                    iconOnly
                    icon="outline-edit"
                    (click)="editProduct(element)"
                  ></button>
                  <button
                    uiButton
                    variant="danger"
                    size="sm"
                    iconOnly
                    icon="outline-trash"
                    (click)="deleteProduct(element)"
                  ></button>
                </div>
              </td>
            </ng-container>

            <tr *cdkHeaderRowDef="displayedColumns" cdk-header-row></tr>
            <tr *cdkRowDef="let row; columns: displayedColumns" cdk-row></tr>

            <tr *cdkNoDataRow class="mat-row">
              <td [attr.colspan]="displayedColumns.length">
                <ui-empty-state
                  title="Товары не найдены"
                  icon="outline-package-off"
                  description="Попробуйте изменить настройки фильтров"
                >
                </ui-empty-state>
              </td>
            </tr>
          </ui-table>
        </ui-card>
      }

      <!--<ui-card>
        <ui-table [loading]="products.isLoading()" [isEmpty]="!filteredProducts().length">
          <tr header>
            <th style="width: 100px">Код</th>
            <th style="width: 300px">Название товара</th>
            <th style="width: 120px">Цена</th>
            <th style="width: 100px">Остаток</th>
            <th style="width: 120px">Статус</th>
            <th style="width: 100px" class="text-right">Actions</th>
          </tr>

          @for (row of filteredProducts(); track row.id) {
            <tr class="hover:bg-slate-50/50">
              &lt;!&ndash; Code &ndash;&gt;
              <td>
                <div class="group flex items-center gap-2">
                  <span class="font-mono text-xs font-semibold text-slate-500" [title]="row.id">
                    ...{{ row.id | slice: -10 }}
                  </span>
                  &lt;!&ndash; Copy button could be added here if needed, keeping it simple for now &ndash;&gt;
                </div>
              </td>

              &lt;!&ndash; Name &ndash;&gt;
              <td>
                <div class="flex items-center gap-3 py-1">
                  <div
                    class="flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-slate-100/80 p-2 text-slate-500"
                  >
                    <ui-icon name="outline-box" width="20" height="20" />
                  </div>
                  <div class="flex flex-col overflow-hidden">
                    <span class="truncate font-semibold text-slate-900">{{ row.name }}</span>
                    <span class="truncate text-xs text-slate-500">
                      {{ row.categoryName }}
                    </span>
                  </div>
                </div>
              </td>

              &lt;!&ndash; Price &ndash;&gt;
              <td class="font-bold">
                {{ row.displayPrice }}
              </td>

              &lt;!&ndash; Stock &ndash;&gt;
              <td class="font-medium text-emerald-600">
                {{ row.displayStock }}
              </td>

              &lt;!&ndash; Status &ndash;&gt;
              <td>
                <ui-badge [variant]="row.isActive ? 'success' : 'neutral'">
                  {{ row.isActive ? 'Активен' : 'Неактивен' }}
                </ui-badge>
              </td>

              &lt;!&ndash; Actions &ndash;&gt;
              <td class="text-right">
                <div class="flex items-center justify-end gap-1">
                  <button
                    uiButton
                    variant="ghost"
                    size="sm"
                    iconOnly
                    icon="outline-eye"
                    (click)="selectedProduct.set(row); openProductPage()"
                  ></button>
                  <button
                    uiButton
                    variant="ghost"
                    size="sm"
                    iconOnly
                    icon="outline-edit"
                    (click)="editProduct(row)"
                  ></button>
                  <button
                    uiButton
                    variant="danger"
                    size="sm"
                    iconOnly
                    icon="outline-trash"
                    (click)="deleteProduct(row)"
                  ></button>
                </div>
              </td>
            </tr>
          }
        </ui-table>
      </ui-card>-->
    </div>
  </div>
}
