<ui-dialog title="Добавить товар" (closeAction)="cancel()">
  <div class="flex flex-col gap-6">
    <!-- Combined Product Info Section -->
    <div class="space-y-4 rounded-lg border border-slate-200 bg-slate-50 p-4">
      <!-- Product Details -->
      <div class="space-y-2 border-b border-slate-200 pb-3">
        <div class="flex items-baseline gap-2">
          <span class="text-xs font-medium text-slate-500">Товар:</span>
          <span class="text-sm font-semibold">{{ product.name }}</span>
        </div>

        <div class="flex items-baseline gap-2">
          <span class="text-xs font-medium text-slate-500">Категория:</span>
          <span class="text-sm text-slate-700">{{ product.category.name || '—' }}</span>
        </div>

        @if (lastPurchasePrice) {
        <div class="flex items-baseline gap-2">
          <span class="text-xs font-medium text-slate-500">Последняя цена закупа:</span>
          <span class="text-sm font-semibold text-emerald-600">
            {{ lastPurchasePrice | currency }}
          </span>
        </div>
        }
      </div>

      <!-- Stock and Prices Info -->
      <div class="grid grid-cols-2 gap-x-8 gap-y-4 text-xs">
        <!-- Stocks -->
        <div class="space-y-2">
          <p class="font-medium text-slate-500">Остатки на складах:</p>
          @if (!product.stocks.length) {
          <p class="text-slate-400 italic">Нет данных</p>
          }
          @for (stock of product.stocks; track stock.id) {
          <div class="flex justify-between border-b border-dashed border-slate-300 pb-1">
            <span>{{ stock.store.name || 'Склад' }}</span>
            <span class="font-medium">{{ stock.quantity | number }} шт.</span>
          </div>
          }
        </div>

        <!-- Current Prices -->
        <div class="space-y-2">
          <p class="font-medium text-slate-500">Текущие цены:</p>
          @for (pt of priceTypes; track pt.id) {
          @let price = product.prices | find: 'priceTypeId' : pt.id;
          <div class="flex justify-between border-b border-dashed border-slate-300 pb-1">
            <span>{{ pt.name }}</span>
            <span class="font-medium">
              {{ price ? ($any(price).value | currency) : '—' }}
            </span>
          </div>
          }
        </div>
      </div>
    </div>

    <div class="grid grid-cols-2 gap-4">
      <ui-input-number label="Количество" placeholder="0" autofocus [formField]="formData.quantity" />

      <div class="space-y-1">
        <ui-input-number label="Цена закупа" placeholder="0" [formField]="formData.price" />

        <div class="flex items-center justify-between">
          <span class="text-[10px] text-slate-500">
            Текущая: {{ lastPurchasePrice ? (lastPurchasePrice | currency) : '—' }}
          </span>

          @if (purchasePriceChangePercentage() !== 0) {
          <div class="flex items-center gap-1 text-[10px]">
            @if (purchasePriceChangePercentage() > 0) {
            <ui-icon name="outline-trending-up" size="14" class="text-emerald-600" />
            <span class="font-medium text-emerald-600">
              +{{ purchasePriceChangePercentage() | number: '1.1-1' }}%
            </span>
            } @else {
            <ui-icon name="outline-trending-down" size="14" class="text-red-600" />
            <span class="font-medium text-red-600">
              {{ purchasePriceChangePercentage() | number: '1.1-1' }}%
            </span>
            }
          </div>
          }
        </div>
      </div>
    </div>

    @if (priceTypes.length > 0) {
    <div class="space-y-4">
      <h3 class="text-sm font-semibold">Цены продажи</h3>
      <div class="space-y-4">
        @for (pt of priceTypes; track pt.id) {
        <div class="space-y-1">
          @let currentPrice = product.prices | find: 'priceTypeId' : pt.id;
          <ui-input-number [label]="pt.name" [placeholder]="pt.name" [value]="formState().newPrices[pt.id]" [invalid]="
                  formState().newPrices[pt.id] > 0 &&
                  formState().newPrices[pt.id] < formState().price
                " [touched]="formState().newPrices[pt.id] > 0" [errors]="
                  formState().newPrices[pt.id] > 0 &&
                  formState().newPrices[pt.id] < formState().price
                    ? [{ kind: 'error', message: 'Цена ниже закупа' }]
                    : []
                " (valueChange)="updateNewPrice(pt.id, $event)" />

          <div class="flex items-center justify-between">
            <span class="text-[10px] text-slate-500">
              Текущая: {{ currentPrice ? ($any(currentPrice).value | currency) : '—' }}
            </span>

            @if (priceChangePercentages()[pt.id] !== 0 && formState().newPrices[pt.id] > 0) {
            <div class="flex items-center gap-1 text-[10px]">
              @if (priceChangePercentages()[pt.id] > 0) {
              <ui-icon name="outline-trending-up" size="14" class="text-emerald-600" />
              <span class="font-medium text-emerald-600">
                +{{ priceChangePercentages()[pt.id] | number: '1.1-1' }}%
              </span>
              } @else {
              <ui-icon name="outline-trending-down" size="14" class="text-red-600" />
              <span class="font-medium text-red-600">
                {{ priceChangePercentages()[pt.id] | number: '1.1-1' }}%
              </span>
              }
            </div>
            }
          </div>
        </div>
        }
      </div>
    </div>
    }
  </div>

  <button footer uiButton variant="ghost" (click)="cancel()">Отмена</button>
  <button footer uiButton variant="primary" [disabled]="!isValid()" (click)="save()">
    Добавить
  </button>
</ui-dialog>