<!--todo clean page-->
@if (purchaseResource.isLoading()) {
  <div class="flex h-64 items-center justify-center">
    <ui-loading width="48" height="48" />
  </div>
} @else if (purchaseResource.hasValue()) {
  <div class="space-y-4">
    <div class="flex items-center justify-between">
      <ui-title
        withBackBtn
        [title]="`Закупка ${purchaseResource.value().code}`"
        [caption]="`ID: ${purchaseResource.value().id}`"
      />

      <div class="flex gap-2">
        <button
          uiButton
          variant="primary"
          [loading]="isSaving()"
          [disabled]="formData().invalid() || items().length === 0"
          (click)="save()"
        >
          Сохранить изменения
        </button>
      </div>
    </div>

    <!-- Header Info -->
    <ui-card class="col-span-2 space-y-4 p-4">
      <h2 class="font-medium">Общая информация</h2>

      <div class="grid grid-cols-2 gap-4">
        <ui-select
          label="Магазин/Склад"
          placeholder="Выберите склад"
          optionLabel="name"
          optionField="id"
          [items]="stores.value() || []"
          [formField]="formData.storeId"
        />

        <ui-select
          label="Поставщик"
          placeholder="Выберите поставщика"
          optionLabel="name"
          optionField="id"
          [items]="vendors.value() || []"
          [formField]="formData.vendorId"
        />

        <ui-input label="Дата документа" type="date" [formField]="formData.date" />

        <ui-input label="Примечание" placeholder="Необязательно" [formField]="formData.notes" />
      </div>
    </ui-card>

    <!-- Items Table -->
    <ui-card>
      <div class="default-border-color flex items-center justify-between border-b p-4">
        <h2 class="font-medium">Товары в закупке</h2>

        <button
          uiButton
          variant="secondary"
          size="sm"
          icon="outline-plus"
          (click)="openProductSearch()"
        >
          Добавить товар
        </button>
      </div>

      <ui-table [dataSource]="items()">
        <ng-container cdkColumnDef="status">
          <th *cdkHeaderCellDef cdk-header-cell class="w-10"></th>
          <td *cdkCellDef="let item" cdk-cell class="py-3">
            @if (item.isSaved) {
              <ui-icon name="outline-cloud" class="text-emerald-500" />
            } @else {
              <ui-icon name="outline-cloud" class="text-orange-400" />
            }
          </td>
        </ng-container>

        <ng-container cdkColumnDef="product">
          <th *cdkHeaderCellDef cdk-header-cell>Товар</th>
          <td *cdkCellDef="let item" cdk-cell class="py-3">
            <div class="font-medium">{{ item.productName }}</div>
          </td>
        </ng-container>

        @for (pt of priceTypes.value(); track pt.id) {
          <ng-container [cdkColumnDef]="pt.id">
            <th *cdkHeaderCellDef cdk-header-cell class="w-24 min-w-24">
              <div class="flex flex-col">
                <span class="text-xs font-semibold uppercase">{{ pt.name }}</span>
              </div>
            </th>
            <td *cdkCellDef="let item" cdk-cell class="py-3">
              @let priceInfo = item.newPrices | find: 'priceTypeId' : pt.id;
              @if (priceInfo) {
                <div class="flex flex-col gap-1">
                  <ui-input-number
                    placeholder="0"
                    [value]="$any(priceInfo).value"
                    [disabled]="item.isSaved"
                    (valueChange)="updateNewPrice(item.tempId, pt.id, $event)"
                  />
                  <span class="text-xs whitespace-nowrap text-slate-500">
                    <!--todo fix-->
                    Текущая: {{ $any(priceInfo).currentValue | currency }}
                  </span>
                </div>
              }
            </td>
          </ng-container>
        }

        <ng-container cdkColumnDef="quantity">
          <th *cdkHeaderCellDef cdk-header-cell class="w-24">Кол-во</th>
          <td *cdkCellDef="let item" cdk-cell>
            <ui-input-number
              [value]="item.quantity"
              (valueChange)="updateItem(item.tempId, 'quantity', $event)"
            />
          </td>
        </ng-container>

        <ng-container cdkColumnDef="price">
          <th *cdkHeaderCellDef cdk-header-cell class="w-32">Цена зак.</th>
          <td *cdkCellDef="let item" cdk-cell>
            <ui-input-number
              [value]="item.price"
              (valueChange)="updateItem(item.tempId, 'price', $event)"
            />
          </td>
        </ng-container>

        <ng-container cdkColumnDef="total">
          <th *cdkHeaderCellDef cdk-header-cell class="w-32">Сумма</th>
          <td *cdkCellDef="let item" cdk-cell class="font-semibold text-slate-700">
            {{ item.quantity * item.price | currency }}
          </td>
        </ng-container>

        <ng-container cdkColumnDef="actions">
          <th *cdkHeaderCellDef cdk-header-cell class="w-10"></th>
          <td *cdkCellDef="let item" cdk-cell>
            <button class="text-slate-400 hover:text-red-500" (click)="removeItem(item.tempId)">
              <ui-icon name="outline-trash" size="sm" />
            </button>
          </td>
        </ng-container>

        <tr *cdkHeaderRowDef="displayedColumns()" cdk-header-row></tr>
        <tr *cdkRowDef="let row; columns: displayedColumns()" cdk-row></tr>

        <tr *cdkNoDataRow>
          <td [attr.colspan]="displayedColumns().length">
            <ui-empty-state
              title="Список товаров пуст"
              icon="outline-box"
              description="Добавьте товар, чтобы начать"
            />
          </td>
        </tr>
      </ui-table>
    </ui-card>
  </div>
}
