<!-- Header -->
<div class="flex items-center justify-between">
  <div class="flex items-center gap-4">
    <button uiButton variant="ghost" icon="arrow-left" size="icon" (click)="cancel()">
      <span class="sr-only">Назад</span>
    </button>
    <h1 class="typo-h1">
      {{ isEdit() ? 'Редактирование накладной' : 'Новая накладная' }}
    </h1>
  </div>

  <div class="flex items-center gap-2">
    <button uiButton variant="ghost" (click)="cancel()">Отмена</button>
    <button
      uiButton
      variant="primary"
      icon="check"
      [disabled]="!formData().valid() || itemsState().length === 0"
      [loading]="loading()"
      (click)="save()"
    >
      {{ isEdit() ? 'Сохранить' : 'Создать' }}
    </button>
  </div>
</div>

<!-- Main Content -->
<div class="flex flex-1 gap-4 overflow-hidden">
  <!-- Sidebar: Info -->
  <ui-card class="w-80 gap-4 overflow-y-auto p-4">
    <h2 class="text-lg font-semibold">Основное</h2>

    @if (id()) {
      <ui-input label="Номер" [value]="id()!" [disabled]="true" [readonly]="true" />
    }

    <ui-input type="datetime-local" label="Дата" [formField]="formData.date" />

    <ui-select
      label="Склад"
      labelField="name"
      selectField="id"
      [items]="stores.value() || []"
      [selectedList]="formState().storeId ? [formState().storeId] : []"
      (selectedListChange)="updateStoreId($event[0])"
    />

    <ui-select
      label="Поставщик"
      labelField="name"
      selectField="id"
      [items]="vendors.value() || []"
      [selectedList]="formState().vendorId ? [formState().vendorId] : []"
      (selectedListChange)="updateVendorId($event[0])"
    />
  </ui-card>

  <!-- Content: Items -->
  <ui-card class="flex flex-1 flex-col overflow-hidden p-0">
    <div class="flex items-center justify-between border-b border-gray-100 p-4">
      <h2 class="text-lg font-semibold">Товары</h2>
      <button uiButton variant="secondary" icon="plus" size="sm" (click)="addItem()">
        Добавить товар
      </button>
    </div>

    <div class="flex-1 overflow-auto p-4">
      <table class="w-full text-left text-sm">
        <thead class="border-b border-gray-100 font-medium text-gray-500">
          <tr>
            <th class="px-4 py-2">
              Товар
              <span class="text-red-500">*</span>
            </th>
            <th class="w-32 px-4 py-2">
              Кол-во
              <span class="text-red-500">*</span>
            </th>
            <th class="w-32 px-4 py-2">
              Закуп. цена
              <span class="text-red-500">*</span>
            </th>
            <!-- Dynamic Price Types Headers -->
            @for (pt of priceTypes.value(); track pt.id) {
              <th class="w-32 px-4 py-2">
                {{ pt.name }}
                <span class="text-red-500">*</span>
              </th>
            }
            <th class="w-32 px-4 py-2">Сумма</th>
            <th class="w-10 px-4 py-2"></th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-50">
          @for (item of itemsState(); track item; let i = $index) {
            <tr>
              <td class="px-4 py-2">
                <ui-select
                  labelField="name"
                  selectField="id"
                  placeholder="Выберите товар"
                  [items]="products.value() || []"
                  [selectedList]="item.productId() ? [item.productId()] : []"
                  (selectedListChange)="updateProduct(i, $event[0])"
                />
              </td>
              <td class="px-4 py-2">
                <ui-input
                  type="number"
                  [value]="item.quantity()"
                  (valueChange)="item.quantity.set(+$event)"
                />
              </td>
              <td class="px-4 py-2">
                <ui-input
                  type="number"
                  [value]="item.price()"
                  (valueChange)="item.price.set(+$event)"
                />
              </td>
              <!-- Dynamic Price Types Inputs -->
              @for (price of item.newPrices; track price.priceTypeId) {
                <td class="px-4 py-2">
                  <ui-input
                    type="number"
                    [value]="price.value()"
                    (valueChange)="price.value.set(+$event)"
                  />
                </td>
              }

              <td class="px-4 py-2 text-right font-medium">
                {{ item.quantity() * item.price() | number }}
              </td>
              <td class="px-4 py-2">
                <button
                  uiButton
                  variant="ghost"
                  icon="trash"
                  size="icon"
                  class="text-red-500 hover:text-red-700"
                  (click)="removeItem(i)"
                >
                  <span class="sr-only">Удалить</span>
                </button>
              </td>
            </tr>
          }
        </tbody>
      </table>

      @if (itemsState().length === 0) {
        <div class="flex flex-col items-center justify-center p-8 text-gray-400">
          <span class="text-lg">Нет товаров</span>
          <span class="text-sm">Добавьте товары в документ</span>
        </div>
      }
    </div>

    <div class="flex justify-end gap-8 border-t border-gray-100 bg-gray-50 p-4">
      <div class="flex flex-col text-right">
        <span class="text-xs text-gray-500">Итого товаров</span>
        <span class="font-bold">{{ itemsState().length }}</span>
      </div>
      <div class="flex flex-col text-right">
        <span class="text-xs text-gray-500">На сумму</span>
        <span class="text-primary-600 text-lg font-bold">{{ totalAmount() | number }}</span>
      </div>
    </div>
  </ui-card>
</div>
