<ui-page-header
  showBack
  [title]="purchase.value()?.code ? `Закупка №${purchase.value()?.code}` : 'Закупка'"
>
  <div actions class="flex gap-2">
    @if (purchase.value()?.status === DocumentStatus.COMPLETED) {
      <button
        uiButton
        variant="danger"
        [disabled]="purchase.isLoading()"
        (click)="updateStatus(DocumentStatus.DRAFT)"
      >
        Отменить проведение
      </button>
    }

    @if (purchase.value()?.status === DocumentStatus.DRAFT) {
      <button
        uiButton
        variant="secondary"
        icon="outline-check"
        [disabled]="purchase.isLoading()"
        (click)="updateStatus(DocumentStatus.COMPLETED)"
      >
        Провести
      </button>
    }

    <button
      uiButton
      variant="primary"
      [disabled]="purchase.isLoading() || formData().invalid()"
      (click)="save()"
    >
      Сохранить
    </button>
  </div>
</ui-page-header>

<ui-breadcrumb class="mb-2 block" [items]="breadcrumbItems()" />

@if (purchase.isLoading()) {
  <ui-loading [width]="48" [height]="48" />
} @else if (purchase.value(); as p) {
  <div class="grid grid-cols-3 gap-6">
    <!-- Main Content -->
    <div class="col-span-2 flex flex-col gap-6">
      <!-- Order Info -->
      <ui-card>
        <div class="p-6">
          <h2 class="mb-4 text-lg font-semibold">Информация о заказе</h2>
          <div class="grid grid-cols-2 gap-4">
            <ui-input label="Номер заказа" placeholder="Номер заказа" [formField]="formData.code" />
            <ui-input
              label="Дата заказа"
              placeholder="Дата заказа"
              type="datetime-local"
              icon="outline-calendar"
              [formField]="formData.date"
            />

            <ui-select
              label="Поставщик"
              placeholder="Выберите поставщика"
              icon="outline-users"
              optionLabel="name"
              optionField="id"
              [items]="vendors.value()"
              [formField]="formData.vendorId"
            />

            <ui-select
              label="Склад получения"
              placeholder="Выберите склад"
              icon="outline-building-store"
              optionLabel="name"
              optionField="id"
              [items]="stores.value()"
              [formField]="formData.storeId"
            />
          </div>
        </div>
      </ui-card>

      <!-- Items List -->
      <ui-card class="overflow-hidden">
        <div class="default-border-color flex items-center justify-between border-b p-4">
          <div class="flex items-center gap-2">
            <h2 class="text-lg font-semibold">Товары</h2>
            <span class="text-sm text-slate-500">{{ totalPositions() }} позиций</span>
          </div>
          <button
            uiButton
            variant="secondary"
            size="sm"
            icon="outline-plus"
            (click)="openItemDialog()"
          >
            <span>Добавить товар</span>
          </button>
        </div>

        <div class="flex flex-col gap-4 p-4">
          @if (formState().items.length) {
            @for (item of formState().items; track item.productId + $index; let i = $index) {
              @if (!deletedIndices().has(i)) {
                <app-purchase-item-card
                  [item]="item"
                  [priceTypes]="priceTypes.value() || []"
                  [status]="purchase.value()?.status || DocumentStatus.DRAFT"
                  [readonly]="purchase.value()?.status === DocumentStatus.COMPLETED"
                  (edit)="openItemDialog(item, i)"
                  (remove)="removeProduct(i)"
                />
              } @else {
                <!-- Deleted Item Placeholder/Restore UI if needed, for now just hidden or simple restore block -->
                <div
                  class="flex items-center justify-between rounded-xl border border-dashed border-red-200 bg-red-50 p-4"
                >
                  <div class="text-sm text-red-600">
                    Товар <b>{{ item.productName }}</b> удален
                  </div>
                  <button uiButton variant="ghost" size="sm" (click)="restoreProduct(i)">
                    Восстановить
                  </button>
                </div>
              }
            }
          } @else {
            <div class="py-12 text-center text-slate-500">
              <ui-icon name="outline-box" class="mx-auto mb-3 h-12 w-12 opacity-30" />
              <p class="text-sm">В заказе нет товаров. Нажмите "Добавить товар", чтобы начать.</p>
            </div>
          }
        </div>

        <div class="p-4">
          <div class="flex items-end justify-between">
            <span class="text-lg font-bold">Итого:</span>
            <span class="text-2xl font-bold text-green-600">
              {{ totalAmount() | number }}
            </span>
          </div>
        </div>
      </ui-card>

      <!-- Notes -->
      <ui-card>
        <div class="p-6">
          <h2 class="mb-4 text-lg font-semibold">Примечания</h2>
          <ui-input
            placeholder="Дополнительная информация о заказе..."
            [formField]="formData.notes"
          />
        </div>
      </ui-card>
    </div>

    <!-- Sidebar -->
    <div class="sticky top-4 flex flex-col gap-6">
      <!-- Document Status -->
      <ui-card>
        <div class="p-6">
          <div class="flex flex-col gap-4">
            <div class="flex items-center justify-between text-sm">
              <span class="text-slate-500">Статус:</span>
              <app-document-status [status]="p.status" />
            </div>
          </div>
        </div>
      </ui-card>

      <!-- History Widget -->
      <app-document-history [history]="purchase.value()?.history" [productMap]="productMap()" />
    </div>
  </div>
} @else {
  <ui-card class="p-8 text-center text-slate-500"> Закупка не найдена</ui-card>
}
