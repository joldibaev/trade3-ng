<ui-page-header
  [title]="purchase.value()?.code ? 'Закупка №' + purchase.value()?.code : 'Закупка'"
  (back)="back()"
>
  <div actions>
    <button uiButton variant="primary" [disabled]="purchase.isLoading()" (click)="save()">
      Сохранить
    </button>
  </div>
</ui-page-header>

<ui-breadcrumb class="mb-2 block" [items]="breadcrumbItems()" />

@if (purchase.isLoading()) {
  <ui-loading [width]="48" [height]="48" />
} @else if (purchase.value(); as p) {
  <!-- Main Info -->
  <ui-card>
    <div class="p-6">
      <h2 class="mb-4 text-lg font-semibold">Общая информация</h2>
      <div class="grid grid-cols-2 gap-y-4 text-sm">
        <div class="text-neutral-500">Статус:</div>
        <div>
          <app-document-status [status]="p.status" />
        </div>

        <div class="text-neutral-500">Код:</div>
        <div class="font-medium">{{ p.code || '-' }}</div>

        <div class="text-neutral-500">Дата:</div>
        <div class="font-medium">{{ p.date | date: 'dd.MM.yyyy HH:mm' }}</div>

        <div class="text-neutral-500">Поставщик:</div>
        <div class="font-medium">{{ p.vendor?.name || '-' }}</div>

        <div class="text-neutral-500">Магазин:</div>
        <div class="font-medium">{{ p.store.name || '-' }}</div>
      </div>
    </div>
  </ui-card>

  <!-- Items Table -->
  <ui-card class="mt-4 block overflow-hidden">
    <div class="default-border-color flex items-center justify-between border-b p-4">
      <h2 class="text-lg font-semibold">Товары</h2>
      <button uiButton variant="secondary" size="sm" icon="outline-plus" (click)="openItemDialog()">
        Добавить товар
      </button>
    </div>

    <ui-table
      gridDisabled
      [columns]="columns()"
      [data]="formState().items"
      [trackField]="'productId'"
      [rowClass]="rowClass"
      [templates]="{ actions: actions }"
    />

    <ng-template #actions let-item let-index="index">
      <div class="flex items-center justify-end gap-2">
        @if (item.isDeleted) {
          <button
            uiButton
            variant="ghost"
            size="icon"
            icon="outline-refresh"
            class="text-green-500 hover:bg-green-50 hover:text-green-600"
            (click)="restoreProduct(index)"
          >
            <span class="sr-only">Восстановить</span>
          </button>
        } @else {
          <button
            uiButton
            variant="ghost"
            size="icon"
            icon="outline-pencil"
            class="text-blue-500 hover:bg-blue-50 hover:text-blue-600"
            (click)="openItemDialog(item, index)"
          >
            <span class="sr-only">Редактировать</span>
          </button>
          <button
            uiButton
            variant="ghost"
            size="icon"
            icon="outline-trash"
            class="text-red-500 hover:bg-red-50 hover:text-red-600"
            (click)="removeProduct(index)"
          >
            <span class="sr-only">Удалить</span>
          </button>
        }
      </div>
    </ng-template>

    <div class="flex items-center justify-end gap-8 border-t border-neutral-200 p-4 font-semibold">
      <div>Итого кол-во: {{ totalQuantity() }}</div>
      <div>Итого сумма: {{ totalAmount() | currency: 'UZS' : 'symbol-narrow' }}</div>
    </div>
  </ui-card>
} @else {
  <ui-card class="p-8 text-center text-neutral-500"> Закупка не найдена</ui-card>
}
