<div class="flex flex-col gap-6">
  <!-- Header -->
  <div class="flex flex-col justify-between gap-4 sm:flex-row sm:items-center">
    <div>
      <h1 class="text-2xl font-bold tracking-tight text-slate-900">Закупки</h1>
      <p class="text-sm text-slate-500">Управляйте поступлениями товаров от поставщиков</p>
    </div>
    <button uiButton variant="primary" icon="outline-plus" (click)="openCreateDialog()">
      Создать закупку
    </button>
  </div>

  @if (purchases.isLoading()) {
    <div class="flex h-64 items-center justify-center">
      <ui-loading [width]="40" [height]="40" />
    </div>
  } @else {
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 gap-6 md:grid-cols-3">
      @for (stat of stats(); track stat.label) {
        <ui-card class="flex items-center gap-4 p-6">
          <div
            class="flex h-12 w-12 shrink-0 items-center justify-center rounded-xl transition-colors duration-200"
            [class]="stat.color"
          >
            <ui-icon width="24" height="24" [name]="stat.icon" />
          </div>

          <div>
            <p class="text-sm font-medium text-slate-500">{{ stat.label }}</p>
            @if (stat.isCurrency) {
              <p class="text-2xl font-bold text-slate-900">
                {{ stat.value | number: '1.0-0' }} UZS
              </p>
            } @else {
              <p class="text-2xl font-bold text-slate-900">{{ stat.value }}</p>
            }
          </div>
        </ui-card>
      }
    </div>

    <!-- Search Area -->
    <div class="grid grid-cols-1 gap-6 md:grid-cols-4">
      <ui-input
        placeholder="Поиск по коду, поставщику или магазину..."
        class="lg:col-span-1"
        [formField]="searchForm.query"
      ></ui-input>
    </div>

    <!-- Data Table -->
    <ui-card>
      <ui-table [loading]="purchases.isLoading()" [isEmpty]="!filteredPurchases().length">
        <tr header>
          <th style="width: 80px">Код</th>
          <th style="width: 120px">Статус</th>
          <th style="width: 140px">Дата</th>
          <th>Поставщик</th>
          <th>Магазин</th>
          <th style="width: 160px">Сумма</th>
          <th style="width: 120px" class="text-right">Действия</th>
        </tr>

        @for (row of filteredPurchases(); track row.id) {
          <tr class="hover:bg-slate-50/50">
            <!-- Code -->
            <td>
              <span class="font-mono text-slate-500">#{{ row.code || '-' }}</span>
            </td>

            <!-- Status -->
            <td>
              <app-document-status [status]="row.status" />
            </td>

            <!-- Date -->
            <td>
              <div class="flex items-center gap-2">
                <ui-icon width="16" height="16" name="outline-calendar" class="text-slate-400" />
                <span>{{ row.date ? (row.date | date: 'dd.MM.yyyy') : '-' }}</span>
              </div>
            </td>

            <!-- Vendor -->
            <td>
              <div class="flex items-center gap-2">
                <ui-icon width="16" height="16" name="outline-truck" class="text-slate-400" />
                <span class="truncate">{{ row.vendor?.name || '-' }}</span>
              </div>
            </td>

            <!-- Store -->
            <td>
              <div class="flex items-center gap-2">
                <ui-icon
                  width="16"
                  height="16"
                  name="outline-building-store"
                  class="text-slate-400"
                />
                <span class="truncate">{{ row.store.name || '-' }}</span>
              </div>
            </td>

            <!-- Total -->
            <td>
              <span class="font-bold text-slate-900"> {{ row.total | number: '1.0-0' }} UZS </span>
            </td>

            <!-- Actions -->
            <td class="text-right">
              <div class="flex items-center justify-end gap-1">
                @if (row.status === DocumentStatus.DRAFT) {
                  <button
                    uiButton
                    variant="ghost"
                    size="sm"
                    iconOnly
                    icon="outline-check"
                    title="Провести"
                    (click)="updateStatus(row.id, DocumentStatus.COMPLETED)"
                  ></button>
                } @else if (row.status === DocumentStatus.COMPLETED) {
                  <button
                    uiButton
                    variant="ghost"
                    size="sm"
                    iconOnly
                    icon="outline-arrow-left"
                    title="Отменить проведение"
                    (click)="updateStatus(row.id, DocumentStatus.DRAFT)"
                  ></button>
                }
                <button
                  uiButton
                  variant="ghost"
                  size="sm"
                  iconOnly
                  icon="outline-eye"
                  (click)="openDetails(row)"
                ></button>
                <button
                  uiButton
                  variant="danger"
                  size="sm"
                  iconOnly
                  icon="outline-trash"
                  (click)="deletePurchase(row)"
                ></button>
              </div>
            </td>
          </tr>
        }
      </ui-table>
    </ui-card>
  }
</div>
