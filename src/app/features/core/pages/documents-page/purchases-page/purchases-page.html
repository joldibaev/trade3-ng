<div class="flex flex-col gap-6">
  <!-- Header -->
  <div class="flex items-center justify-between gap-4">
    <ui-title title="Закупки" caption="Управляйте поступлениями товаров от поставщиков" />

    <button uiButton variant="primary" icon="outline-plus" (click)="openCreateDialog()">
      Создать закупку
    </button>
  </div>

  @if (purchases.isLoading()) {
    <div class="flex h-64 items-center justify-center">
      <ui-loading [width]="40" [height]="40" />
    </div>
  } @else {
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 gap-6 md:grid-cols-3">
      @for (stat of stats(); track stat.label) {
        <ui-stat-card
          [color]="stat.color"
          [icon]="stat.icon"
          [label]="stat.label"
          [value]="stat.value"
        />
      }
    </div>

    <!-- Search Area -->
    <div class="grid grid-cols-1 gap-6 md:grid-cols-4">
      <ui-input
        placeholder="Поиск по коду, поставщику или магазину..."
        class="lg:col-span-1"
        [formField]="searchForm.query"
      ></ui-input>
    </div>

    <!-- Data Table -->
    <ui-card>
      <ui-table [dataSource]="filteredPurchases()">
        <ng-container cdkColumnDef="code">
          <th *cdkHeaderCellDef cdk-header-cell>Код</th>
          <td *cdkCellDef="let element" cdk-cell>
            <div class="flex flex-col">
              <span class="font-semibold">#{{ element.code }}</span>
              <span class="text-xs text-slate-500">{{ element.id }}</span>
            </div>
          </td>
        </ng-container>

        <ng-container cdkColumnDef="date">
          <th *cdkHeaderCellDef cdk-header-cell>Дата</th>
          <td *cdkCellDef="let element" cdk-cell>
            <div class="flex flex-col">
              <span class="text-sm">{{ element.date | date: 'dd.MM.yyyy' }}</span>
              <span class="text-xs text-slate-500">{{ element.date | date: 'HH:mm' }}</span>
            </div>
          </td>
        </ng-container>

        <ng-container cdkColumnDef="vendor">
          <th *cdkHeaderCellDef cdk-header-cell>Поставщик</th>
          <td *cdkCellDef="let element" cdk-cell>
            <span>{{ element.vendor.name }}</span>
          </td>
        </ng-container>

        <ng-container cdkColumnDef="store">
          <th *cdkHeaderCellDef cdk-header-cell>Магазин</th>
          <td *cdkCellDef="let element" cdk-cell>
            {{ element.store.name }}
          </td>
        </ng-container>

        <ng-container cdkColumnDef="total">
          <th *cdkHeaderCellDef cdk-header-cell>Сумма</th>
          <td *cdkCellDef="let element" cdk-cell class="font-semibold">
            {{ element.total | currency }}
          </td>
        </ng-container>

        <ng-container cdkColumnDef="generatedPriceChange">
          <th *cdkHeaderCellDef cdk-header-cell>Связан с</th>
          <td *cdkCellDef="let element" cdk-cell>
            <a
              uiButton
              variant="link"
              icon="outline-package"
              [routerLink]="['/core/documents/purchases', element.generatedPriceChange.id]"
            >
              {{ element.generatedPriceChange.code }}
            </a>
          </td>
        </ng-container>

        <ng-container cdkColumnDef="status">
          <th *cdkHeaderCellDef cdk-header-cell>Статус</th>
          <td *cdkCellDef="let element" cdk-cell>
            <app-document-status [status]="element.status" />
          </td>
        </ng-container>

        <ng-container cdkColumnDef="action">
          <th *cdkHeaderCellDef cdk-header-cell class="text-right"></th>
          <td *cdkCellDef="let element" cdk-cell>
            <div class="flex items-center justify-end gap-1">
              @if (element.status === DocumentStatus.DRAFT) {
                <button
                  uiButton
                  variant="ghost"
                  size="sm"
                  (click)="updateStatus(element.id, DocumentStatus.COMPLETED)"
                >
                  Провести
                </button>
              } @else if (
                element.status === DocumentStatus.COMPLETED ||
                element.status === DocumentStatus.SCHEDULED
              ) {
                <button
                  uiButton
                  variant="ghost"
                  size="sm"
                  (click)="updateStatus(element.id, DocumentStatus.DRAFT)"
                >
                  Отменить проведение
                </button>
              }
              <button
                uiButton
                variant="ghost"
                size="sm"
                iconOnly
                icon="outline-eye"
                (click)="openDetails(element)"
              ></button>
            </div>
          </td>
        </ng-container>

        <tr *cdkHeaderRowDef="displayedColumns" cdk-header-row></tr>
        <tr *cdkRowDef="let row; columns: displayedColumns" cdk-row></tr>

        <tr *cdkNoDataRow>
          <td [attr.colspan]="displayedColumns.length">
            <ui-empty-state
              title="Закупки не найдены"
              icon="outline-file-text"
              description="Попробуйте изменить параметры поиска"
            />
          </td>
        </tr>
      </ui-table>
    </ui-card>
  }
</div>
