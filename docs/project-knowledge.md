# Обзор проекта: Trade3-NG

Этот документ содержит полный обзор проекта `trade3-ng`, основанный на анализе кодовой базы и проверках, выполненных ИИ-ассистентом.

## 1. Стек технологий

- **Фреймворк**: Angular v21 (последние версии bleeding edge/nightly в `package.json`).
- **Язык**: TypeScript ~5.9.
- **Стилизация**: Tailwind CSS v4.
  - Настроен в `src/styles.css` с использованием новых директив `@theme` и `@import`.
  - **Модульность стилей**: Стили компонентов вынесены в `src/styles/components/*.css` (например, `_list.css`, `_menu.css`) и импортируются в главный файл. Используются паттерны utility-first классов через `@apply` (например, `.ui-list`, `.ui-list-item`).
  - Использует нативные CSS-переменные для темизации (например, `--color-primary-500`).
- **Иконки**: Кастомная SVG система.
  - Используются **только** иконки [Tabler Icons](https://tabler.io/icons). Исходные SVG находятся в `src/assets/img/svg`.
  - Генерация/Оптимизация через `npm run icons:sync` (выполняет `scripts/generate-icons/index.js`).
  - Используются через компонент `UiIcon`.
- **HTTP Клиент**: Angular `HttpClient` с интерцепторами.
- **Управление состоянием**: Angular Signals (`signal`, `computed`, `effect`). Тяжелых внешних сторов (NGRX/Elf) не замечено, используется сервис-ориентированное управление на сигналах.
- **Локализация и Валюта**:
  - Основная валюта проекта — **UZS**. Использование других символов (например, ₸) недопустимо.
  - Часовой пояс — **UTC+5** (Ташкент).

## 2. Структура проекта

Проект следует масштабируемой архитектуре Angular:

### `src/app/core`

Содержит синглтон-сервисы, глобальные конфигурации и базовые UI компоненты.

- **`interceptors/`**:
  - `http.interceptor.ts`: Обрабатывает глобальные HTTP ответы. Автоматически перехватывает ошибки API и отображает их через `UiNotyfService`. Обрабатывает стандартные структуры `ApiResponse`.
- **`ui/`**: Переиспользуемые примитивные UI компоненты.
  - `ui-button`: Кнопка. Поддерживает размеры `sm`, `md`, `lg`. Флаг `iconOnly` используется для квадратных кнопок с иконкой.
  - `ui-input`: Поле ввода. Наследует `UiFormControl`.
  - `ui-dialog`: Обертка диалогов.
  - `ui-card`: Карточка.
  - **`ui-notyf`**: Кастомная система уведомлений (тостов), стилизованная под интерфейс "1С Предприятие".
  - **`ui-icon`**: Компонент для рендеринга SVG из сгенерированного бандла иконой.
  - **`ui-badge`**: Компонент для отображения статусов и меток.
  - **`ui-listbox`**: Наследует `UiSelectableControl`.
  - **`ui-select`**: Наследует `UiComboboxControl`.
  - **`ui-autocomplete`**: Наследует `UiComboboxControl` с добавлением поиска.
  - **`ui-table`**: Базовый компонент таблицы.
    - Поддерживает типы колонок: `text`, `number`, `date`, `badge`, `template`.
    - **Выравнивание**: Поле `align` ('left', 'center', 'right').
    - **Шаблоны**: Запрещено использование `$any()`.

### `src/app/features`

Содержит модули и страницы конкретной функциональности.

- **`core/`**: Основная оболочка (layout) приложения.
  - Компонент `Core`: Формирует боковую панель (`Aside`), область основного контента (`router-outlet`).
  - **`components/`**: `table-struct` - шаблон страниц справочников.
  - **`pages/`**:
    - `directories-page`: Управление справочниками.
    - `documents-page`: Обработка документов.
- **`ui-demo/`**: Модуль демонстрации UI компонентов.

### `src/app/shared`

Содержит общие утилиты и типы, используемые в разных фичах.

- **`interfaces/`**: Описания доменных сущностей (`Product`, `Price` и т.д.).
- **`dtos/`**: DTO для создания/обновления.
- **`dialogs/`**: Контракты данных для диалогов.

## 3. Ключевые концепции и соглашения

### UI Компоненты

- **Диалоговые окна (`ui-dialog`)**: На базе `@angular/cdk/dialog`.
- **Стилизация**: Tailwind v4, shadcn-inspired.
- **Обработка ошибок**: Глобальный интерцептор.
- **Даты**: UTC+5, утилита `getCurrentDateAsString`.

### Стандарты кода (`.gemini/GEMINI.md`)

- **Signals**: Обязательно.
- **Standalone**: Обязательно.
- **Control Flow**: `@if`, `@for`.
- **Доступность (A11y)**: Строгое соблюдение.
- **Типизация**: Strict mode.

### Роутинг

- **`withComponentInputBinding()`**: Параметры роута приходят как `input()`.

## 4. Скрипты автоматизации

- **`npm run icons:sync`**: Генерация иконок из SVG.

## 5. Новые паттерны (Form & UI)

### Signal Forms (`@angular/forms/signals`)

- **Инициализация**: `form(state, validators)`.
- **Валидация**: Встроенные валидаторы + кастомные.
- **Интеграция**: `UiInput`, `UiSelect` и др. поддерживают `[formField]`.

### Управление состоянием загрузки

- Оператор `finalize`.

### Работа с датами

- `datetime-local` + `getCurrentDateAsString`.

### Инъекция зависимостей

- `private readonly service = inject(...)`.

### Получение данных

- Поддержка `include` для связей.

## 6. UX Паттерны

### Отложенная валидация (Lazy Validation)

Для предотвращения визуального шума ошибки валидации в полях ввода (`ui-input`, `ui-select` и т.д.) отображаются только при условии `invalid() && touched()`. Это реализовано через вычисляемый сигнал `shouldShowError` в базовом классе `UiFormControl`.
Пользователь не видит красных рамок сразу при открытии формы, пока не повзаимодействует с полем или не попытается отправить форму (что должно помечать поля как `touched`).

### Выбор сущности в диалоге

Двухфазный интерфейс: Autocomplete для поиска -> Static View для выбранного.

### Двухэтапное создание элементов

Selection Dialog -> Details Dialog.

### Мягкое удаление

Флаг `isDeleted`, визуальное зачеркивание.

### Статусы Документов

Использование `UiBadge` со словарями маппинга.

## 7. Архитектура UI компонентов (v2)

В рамках рефакторинга введена строгая иерархия классов для UI компонентов форм, чтобы устранить дублирование кода и стандартизировать поведение.

### Базовые классы (`Directive`)

1.  **`UiFormControl<T>`**:
    - Базовый класс для всех элементов формы.
    - Определяет стандартные input-ы: `disabled`, `readonly`, `invalid`, `errors`, `label`, `placeholder`, `loading`.
    - Управляет генерацией уникального `id` для accessibility.
    - Содержит логику `shouldShowError` (lazy validation).
    - Требует реализации абстрактного `value: Model<T>`.

2.  **`UiSelectableControl<T>`** (наследует `UiFormControl`):
    - Базовый класс для компонентов, работающих с набором данных (Listbox, Select, Autocomplete).
    - Определяет input-ы: `items`, `optionLabel`, `optionField`.
    - Управляет логикой выбора через `selectedList` (linkedSignal) и метод `valuesChange`.

3.  **`UiComboboxControl<T>`** (наследует `UiSelectableControl`):
    - Базовый класс для выпадающих списков (`Select`, `Autocomplete`).
    - Содержит общие `viewChild` запросы для `@angular/aria`: `Listbox`, `Option`, `Combobox`.
    - Реализует логику авто-скролла к выбранному элементу и сброса скролла при закрытии.

### Реализация компонентов

- **`UiInput`**: Наследует `UiFormControl`.
- **`UiListbox`**: Наследует `UiSelectableControl`.
- **`UiSelect`**: Наследует `UiComboboxControl`.
- **`UiAutocomplete`**: Наследует `UiComboboxControl` (+ добавляет логику поиска/фильтрации).
